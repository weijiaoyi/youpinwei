<admintpl file="header" />
</head>
<style type="text/css">
.form-horizontal{

}
.wechat-menu{
	float: left;
	width: 100%;
	padding: 20px 0;
	margin-bottom: 100px;
}
.menu-show{
	float: left;
	width: 300px;
	margin: 0 2% 0 2%;
	background-image: url(https://res.wx.qq.com/mpres/htmledition/images/bg/bg_mobile_head_default2968da.png);
	background-repeat: no-repeat;
	background-size: 100% ;
	height: 450px;
	border: 1px solid black;
}
.menu-show-header{
	float: left;
	width: 100%;
	height: 30px;
	line-height: 30px;
	color: white;
	text-align: center;
	margin-top: 25px;
}
.menu-show-middle{
	float: left;
	width: 100%;
	height: 200px;
	margin-top: 155px;
}
.menu-level-2-container{
	float: left;
	width: 100px;
	color: black;
	opacity: 0;
	border-bottom: 1px solid gray;
}
.menu-show-bottom{
	width: 100%;
	height: 40px;
	float: left;
}
.menu-level-1{
	float: left;
	width: 98px;
	background-color: #f1f2f3;
	color: #383838;
	height: 40px;
	border: 1px solid gray;
	line-height: 40px;
	text-align: center;
	cursor: pointer;
}
.menu-level-2{
	float: left;
	width: 98px;
	background-color: #fafbfc;
	color: #383838;
	height: 38px;
	border: 1px solid gray;
	line-height: 38px;
	text-align: center;
	cursor: pointer;
	border-bottom: 0;
}
.menu-form{
	float: left;
	width: 600px;
	height: 400px;
	border: 1px solid lightgray;
}
.menu-form-title{
	float: left;
	height: 40px;
	background-color: #f1f2f3;
	line-height: 40px;
	width: 580px;
	padding: 0 10px;
	border-bottom: 1px solid lightgray;
}
.menu-form-row{
	margin-top: 20px;
	float: left;
	width: 100%;
	height: 40px;
	line-height: 40px;
}
.menu-form-label{
	float: left;
	width: 100px;
	font-weight: bolder;
	color: black;
	text-align: right;
}
.menu-form-menu-name{
	font-weight: bolder;
}
</style>
<body>
	<div class="wrap">
		<ul class="nav nav-tabs">
			<!-- <li><a href="{:U('user/index')}">{:L('ADMIN_USER_INDEX')}</a></li> -->
			<li class="active"><a href="<?php echo U('Admin/Wechat/C_menuList'); ?>">菜单管理</a></li>
		</ul>
		<div class="form-horizontal">
			<div class="control-group">
				<label class="control-label">服务号：</label>
				<div class="controls">
					<select id="service-select">
					<?php foreach($services as $service){ ?>
						<option value="<?php echo $service['id']; ?>"><?php echo $service['wechat_name']; ?></option>
					<?php } ?>
					</select>
				</div>
			</div>
			<div class="wechat-menu">
				<div class="menu-show">
					<div class="menu-show-header" id="wechat-name">汇信世嘉</div>
					<div class="menu-show-middle">
						<div class="menu-level-2-container" data-l2id="1">
							<div class="menu-level-2" data-l1id="1" data-l2mid="1">Menu-1-1</div>
							<div class="menu-level-2" data-l1id="1" data-l2mid="2">Menu-1-2</div>
							<div class="menu-level-2" data-l1id="1" data-l2mid="3">Menu-1-3</div>
							<div class="menu-level-2" data-l1id="1" data-l2mid="4">Menu-1-4</div>
							<div class="menu-level-2" data-l1id="1" data-l2mid="5">Menu-1-5</div>
						</div>
						<div class="menu-level-2-container" data-l2id="2">
							<div class="menu-level-2" data-l1id="2" data-l2mid="1">Menu-2-1</div>
							<div class="menu-level-2" data-l1id="2" data-l2mid="2">Menu-2-2</div>
							<div class="menu-level-2" data-l1id="2" data-l2mid="3">Menu-2-3</div>
							<div class="menu-level-2" data-l1id="2" data-l2mid="4">Menu-2-4</div>
							<div class="menu-level-2" data-l1id="2" data-l2mid="5">Menu-2-5</div>
						</div>
						<div class="menu-level-2-container" data-l2id="3">
							<div class="menu-level-2" data-l1id="3" data-l2mid="1">Menu-3-1</div>
							<div class="menu-level-2" data-l1id="3" data-l2mid="2">Menu-3-2</div>
							<div class="menu-level-2" data-l1id="3" data-l2mid="3">Menu-3-3</div>
							<div class="menu-level-2" data-l1id="3" data-l2mid="4">Menu-3-4</div>
							<div class="menu-level-2" data-l1id="3" data-l2mid="5">Menu-3-5</div>
						</div>
					</div>	
					<div class="menu-show-bottom">
						<div data-l1id="1" class="menu-level-1">Menu-1</div>
						<div data-l1id="2" class="menu-level-1">Menu-1</div>
						<div data-l1id="3" class="menu-level-1">Menu-1</div>
					</div>
				</div>
				<div class="menu-form">
					<div class="menu-form-title">
						<span>正在编辑菜单－<span class="menu-form-menu-name">Menu-1</span></span>
						<span id="menu-delete" style="float: right;" class="btn btn-primary js-ajax-submit">删除此菜单</span>
					</div>
					<div class="menu-form-middle">
						<div class="menu-form-row">
							<div class="menu-form-label">菜单名称：</div>
							<div class="menu-form-value">
								<input id="menu-name" type="text" placeholder="请输入菜单名称..." />
							</div>
						</div>
						<div class="menu-form-row">
							<div class="menu-form-label">菜单类型：</div>
							<div class="menu-form-value">
								<input type="radio" style="margin: -3px 5px 0 0;" checked="checked"> 跳转链接
							</div>
						</div>
						<div class="menu-form-row">
							<div class="menu-form-label">链接地址：</div>
							<div class="menu-form-value">
								<input id="menu-link" style="width:360px;" type="text" placeholder="请输入链接地址..." />
							</div>
						</div>
						<div class="menu-form-row">
							<button id="menu-add" style="margin: 50px 50px;" class="btn btn-primary js-ajax-submit">确定</button>
						</div>
					</div>
				</div>
				<div class="menu-form-row">
					<button id="menu-submit" style="margin-left: 20px;" class="btn btn-primary js-ajax-submit">保存至服务号</button>
				</div>
			</div>
		</div>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
</body>
<script type="text/javascript">
$(function(){
	var getMenuUrl = "<?php echo U('Admin/Wechat/getWechatMenu', array('config_id'=>'###')); ?>";
	var menuCache = [];
	var configId = 0;
	$('#service-select').change(function(){
		configId = parseInt($(this).val());
		if(configId != 0){
			var url = getMenuUrl.replace('%23%23%23', configId);
			$.ajax({
				url : url,
				success : function(data){
					// 获取微信菜单成功
					if(data.status == 1){
						menuCache[configId] = data.data.menu;
						$('#wechat-name').html($('#service-select option[value="'+configId+'"]').html());
						initMenuShow(configId);
					}
				}
			});
		}else{
			alert('请选择服务号.');
		}
	});
	var clickEvent;
	$('.menu-level-1').dblclick(function(){
		clearTimeout(clickEvent);
		var l1id = $(this).data('l1id');
		$('.menu-level-2-container').css('opacity', 0);
		$('.menu-level-2-container[data-l2id="'+l1id+'"]').css('opacity', 1);
	});
	$('.menu-level-1').add($('.menu-level-2')).click(function(){
		clearTimeout(clickEvent);
		$this = $(this);
		clickEvent = setTimeout(function(){
			initMenuForm($this);
		}, 500);
	});

	$('#menu-add').click(function(){
		var level1Id = parseInt($(this).data('l1id'));
		level1Id = isNaN(level1Id) ? -1 : level1Id;
		if(-1 == level1Id){
			alert('请选择想要编辑的菜单!');
			return false;
		}

		var level2Id = parseInt($(this).data('l2mid'));
		level2Id = isNaN(level2Id) ? 0 : level2Id;

		var name = $('#menu-name').val();
		if(name.trim().length == 0){
			alert('菜单名称不能为空！');
			return false;
		}
		var type = $(this).data('type');
		var link = $('#menu-link').val();
		if(type == 'view'){
			if(link.trim().length == 0){
				alert('菜单链接不能为空！');
				return false;
			}
		}

		if(level2Id == -1){
			menuCache[configId]['button'][level1Id]['name'] = name.trim();
			menuCache[configId]['button'][level1Id]['url'] = link.trim();
		}else{
			menuCache[configId]['button'][level1Id]['sub_button'][level2Id]['name'] = name.trim();
			menuCache[configId]['button'][level1Id]['sub_button'][level2Id]['url'] = link.trim();
		}
		alert('保存成功！');
	});

	$('#menu-submit').click(function(){
		var data = {
			'config_id' : configId,
			'data' : menuCache[configId],
		};
		console.log(data);
		// return false;
		$.ajax({
			url : "<?php echo U('Admin/Wechat/saveWechatMenu'); ?>",
			type : 'post',
			data : data,
			success : function(data){
				alert(data.info);
				if(data.status == 1){
					window.location.reload();
				}
			}
		});
	});

	$('#menu-delete').click(function(){
		var level1Id = parseInt(parseInt($(this).data('l1id')));
		level1Id = isNaN(level1Id) ? -1 : level1Id;
		var level2Id = parseInt(parseInt($(this).data('l2mid')));
		level2Id = isNaN(level2Id) ? -1 : level2Id;
		// 删除一级菜单
		if(level1Id != -1 && level2Id == -1){
			menuCache[configId]['button'][level1Id] = {};
		}
		// 删除二级菜单
		if(level1Id != -1 && level2Id != -1){
			menuCache[configId]['button'][level1Id]['sub_button'][level2Id] = {};
		}
	});

	function initMenuForm(jqDom){
		var level1Id = parseInt(parseInt(jqDom.data('l1id')));
		level1Id = isNaN(level1Id) ? 0 : level1Id;
		var level2Id = parseInt(parseInt(jqDom.data('l2mid')));
		level2Id = isNaN(level2Id) ? 0 : level2Id;
		if(level2Id == 0){
			var menu = {
				'name' : menuCache[configId]['button'][level1Id-1]['name'],
				'type' : menuCache[configId]['button'][level1Id-1]['type'],
				'url' : menuCache[configId]['button'][level1Id-1]['url'],
			};
		}else{
			var menu = {
				'name' : menuCache[configId]['button'][level1Id-1]['sub_button'][level2Id-1]['name'],
				'type' : menuCache[configId]['button'][level1Id-1]['sub_button'][level2Id-1]['type'],
				'url' : menuCache[configId]['button'][level1Id-1]['sub_button'][level2Id-1]['url'],
			};
		}
		$('.menu-form-menu-name').html(menu['name']);
		$('#menu-name').val(menu['name']);
		$('#menu-link').val(menu['url']);

		$('#menu-add').data('l1id', level1Id-1);
		$('#menu-add').data('l2mid', level2Id-1);
		$('#menu-add').data('type', menu['type']);
		$('#menu-delete').data('l1id', level1Id-1);
		$('#menu-delete').data('l2mid', level2Id-1);
	}

	function initMenuShow(configId){
		for(var i=0; i<3; ++i){
			$('.menu-level-1[data-l1id="'+parseInt(i+1)+'"]').html('+');
			for(var j=0; j<5; ++j){
				$('.menu-level-2[data-l1id="'+parseInt(i+1)+'"][data-l2mid="'+parseInt(j+1)+'"]').html('+');
			}
		}
		var data = menuCache[configId]['button'];
		for(var i=0; i<data.length; ++i){
			$('.menu-level-1[data-l1id="'+parseInt(i+1)+'"]').html(data[i]['name']);
			var subMenuNum = parseInt(data[i]['sub_button'].length);
			if(subMenuNum != 0){
				for(var j=0; j<subMenuNum; ++j){
					$('.menu-level-2[data-l1id="'+parseInt(i+1)+'"][data-l2mid="'+parseInt(j+1)+'"]').html(data[i]['sub_button'][j]['name']);
				}
			}
		}
	}

	$('#service-select').val(1);
	$('#service-select').trigger('change');
})
</script>
</html>